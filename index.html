<script>
  // ✅ ضع هنا Published ID الصحيح من رابط Google Sheets (pubhtml)
  const SHEET_PUB_ID = "2PACX-1vRpxvg9aczrDgqw9lKm-Axq_IHzRHrB5YGYk4xZvJZBktRE5T_VOWpdu4ds-pRhsA";

  // ✅ إعدادات الصفحات (CSV)
  const SHEETS_CONFIG = {
    teams:   { gid: "624074873",  nameCol: 0 },  // اسم الفريق (عمود A)
    players: { gid: "374566661",  nameCol: 0, teamCol: 1 }, // اسم اللاعب A / الفريق B
    matches: { gid: "140432292",  nameCol: 0 },
    groups:  { gid: "77308583",   nameCol: 0 },
    news:    { gid: "1073137346", nameCol: 0 }
  };

  // CSV parser بسيط يدعم الفواصل داخل علامات اقتباس
  function parseCSV(text) {
    const rows = [];
    let row = [], cur = "", inQuotes = false;

    for (let i = 0; i < text.length; i++) {
      const ch = text[i], next = text[i+1];

      if (ch === '"' && next === '"') { cur += '"'; i++; continue; }
      if (ch === '"') { inQuotes = !inQuotes; continue; }

      if (!inQuotes && ch === ",") { row.push(cur); cur = ""; continue; }
      if (!inQuotes && (ch === "\n" || ch === "\r")) {
        if (ch === "\r" && next === "\n") i++;
        row.push(cur);
        if (row.some(cell => cell.trim() !== "")) rows.push(row);
        row = []; cur = "";
        continue;
      }
      cur += ch;
    }
    row.push(cur);
    if (row.some(cell => cell.trim() !== "")) rows.push(row);
    return rows;
  }

  function escapeHtml(str) {
    return String(str ?? "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  // ✅ فلترة لاعبي صفحة اللاعبين حسب الفريق
  let selectedTeam = ""; // اسم الفريق المختار

  window.selectTeam = function(teamName){
    selectedTeam = (teamName || "").trim();
    showPage("players");
  };

  function applyPlayersFilter() {
    const bar = document.getElementById("players-filter-bar");
    const teamSpan = document.getElementById("players-filter-team");
    const container = document.getElementById("players-container");
    if (!container) return;

    const cards = Array.from(container.querySelectorAll("[data-player-card]"));

    if (selectedTeam) {
      if (bar) bar.classList.remove("hidden");
      if (teamSpan) teamSpan.textContent = selectedTeam;
    } else {
      if (bar) bar.classList.add("hidden");
    }

    cards.forEach(card => {
      const team = (card.dataset.team || "").trim();
      card.style.display = (!selectedTeam || team === selectedTeam) ? "" : "none";
    });
  }

  document.addEventListener("click", (e) => {
    const clearBtn = e.target.closest("#players-filter-clear");
    if (clearBtn) {
      selectedTeam = "";
      showPage("players");
    }
  });

  async function loadPageData(pageId) {
    const cfg = SHEETS_CONFIG[pageId];
    const container = document.getElementById(`${pageId}-container`);
    if (!cfg || !container) return;

    container.innerHTML = `
      <div class="col-span-full text-center py-10 text-gray-600">
        <i class="fas fa-circle-notch fa-spin text-2xl mb-3"></i>
        <div>جاري التحميل...</div>
      </div>
    `;

    try {
      const url = `https://docs.google.com/spreadsheets/d/e/${SHEET_PUB_ID}/pub?gid=${cfg.gid}&single=true&output=csv&cachebust=${Date.now()}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("HTTP " + res.status);

      const csv = await res.text();
      const table = parseCSV(csv);
      const rows = table.slice(1); // تجاهل الهيدر

      container.innerHTML = "";
      let count = 0;

      for (const r of rows) {
        const name = (r[cfg.nameCol] || "").trim();
        if (!name) continue;
        count++;

        if (pageId === "teams") {
          const safeName = escapeHtml(name);
          container.insertAdjacentHTML("beforeend", `
            <button type="button"
              onclick="selectTeam('${safeName.replace(/&#39;/g, "\\'")}')"
              class="bg-white rounded-xl shadow p-4 text-center hover:shadow-lg transition-shadow cursor-pointer">
              <div class="text-lg font-bold text-blue-800">${safeName}</div>
            </button>
          `);
          continue;
        }

        if (pageId === "players") {
          const team = (r[cfg.teamCol] || "").trim();
          container.insertAdjacentHTML("beforeend", `
            <div data-player-card="1" data-team="${escapeHtml(team)}"
              class="bg-white rounded-xl shadow p-4 text-center hover:shadow-lg transition-shadow">
              <div class="text-lg font-bold text-blue-800">${escapeHtml(name)}</div>
              ${team ? `<div class="text-sm text-gray-600 mt-1">${escapeHtml(team)}</div>` : ``}
            </div>
          `);
          continue;
        }

        container.insertAdjacentHTML("beforeend", `
          <div class="bg-white rounded-xl shadow p-4 text-center hover:shadow-lg transition-shadow">
            <div class="text-lg font-bold text-blue-800">${escapeHtml(name)}</div>
          </div>
        `);
      }

      if (count === 0) {
        container.innerHTML = `<div class="col-span-full text-center py-10 text-gray-600">لا توجد بيانات لعرضها</div>`;
      }

      if (pageId === "players") applyPlayersFilter();

    } catch (e) {
      console.error(e);
      container.innerHTML = `<div class="col-span-full text-center py-10 text-red-600">فشل تحميل البيانات (تأكد أن الشيت منشور للويب)</div>`;
    }
  }

  function showPage(pageId) {
    document.querySelectorAll(".page-section").forEach(s => s.classList.remove("active"));
    const target = document.getElementById(`${pageId}-page`);
    if (target) target.classList.add("active");

    document.querySelectorAll('nav button[data-page]').forEach(btn => {
      btn.classList.remove("active-tab");
      if (btn.dataset.page === pageId) btn.classList.add("active-tab");
    });

    if (SHEETS_CONFIG[pageId]) loadPageData(pageId);
  }

  document.querySelectorAll('nav button[data-page]').forEach(btn => {
    btn.addEventListener("click", () => showPage(btn.dataset.page));
  });

  document.addEventListener("DOMContentLoaded", () => showPage("home"));
</script>
